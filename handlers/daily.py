# D:\telegram_reminder_bot\handlers\daily.py
from aiogram import Router, types, F
from aiogram.filters import Command
from utils.daily import daily_store
from utils.chat_settings import chat_settings

router = Router()

def dkbd(task_id: int, lang: str) -> types.InlineKeyboardMarkup:
    return types.InlineKeyboardMarkup(inline_keyboard=[
        [
            types.InlineKeyboardButton(text="‚úÖ –°–¥–µ–ª–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è" if lang=="ru" else "‚úÖ –ó—Ä–æ–±–ª–µ–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ",
                                       callback_data=f"daily:done:{task_id}"),
            types.InlineKeyboardButton(text="üóë –£–¥–∞–ª–∏—Ç—å" if lang=="ru" else "üóë –í–∏–¥–∞–ª–∏—Ç–∏",
                                       callback_data=f"daily:del:{task_id}"),
        ]
    ])

def top_add_kbd(lang: str) -> types.InlineKeyboardMarkup:
    txt = "‚ûï –î–æ–±–∞–≤–∏—Ç—å" if lang=="ru" else "‚ûï –î–æ–¥–∞—Ç–∏"
    return types.InlineKeyboardMarkup(inline_keyboard=[
        [types.InlineKeyboardButton(text=txt, callback_data="daily:add")]
    ])

@router.message(Command("daily"))
async def cmd_daily(message: types.Message):
    await show_daily_list(message)

async def show_daily_list(message: types.Message):
    user_id = message.from_user.id
    chat_id = message.chat.id
    lang = chat_settings.get_lang(chat_id)
    tasks = daily_store.list(user_id, chat_id)
    if not tasks:
        await message.answer("–°–ø–∏—Å–æ–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø—É—Å—Ç. –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏, —è –¥–æ–±–∞–≤–ª—é." if lang=="ru" else
                             "–°–ø–∏—Å–æ–∫ —â–æ–¥–µ–Ω–Ω–∏—Ö –ø–æ—Ä–æ–∂–Ω—ñ–π. –ù–∞–¥—ñ—à–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞–≤–¥–∞–Ω–Ω—è, —è –¥–æ–¥–∞–º.")
        # –ø–æ–º–µ—Ç–∏–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ FSM-–ø–æ–¥–æ–±–Ω—ã–π —Ñ–ª–∞–≥ –≤ –ø–∞–º—è—Ç—å —á–∞—Ç–∞? –£–ø—Ä–æ—Å—Ç–∏–º: –ø–æ–ø—Ä–æ—Å–∏–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–ª–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
        return
    await message.answer("üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ" if lang=="ru" else "üìÖ –©–æ–¥–µ–Ω–Ω—ñ", reply_markup=top_add_kbd(lang))
    for t in tasks:
        status = "‚úÖ —Å–µ–≥–æ–¥–Ω—è" if t["done_today"] else "‚¨ú —Å–µ–≥–æ–¥–Ω—è"
        await message.answer(f"‚Ä¢ #{t['id']}: {t['text']}  ‚Äî {status}", reply_markup=dkbd(t["id"], lang))

@router.callback_query(F.data == "daily:add")
async def cb_daily_add(cq: types.CallbackQuery):
    lang = chat_settings.get_lang(cq.message.chat.id)
    await cq.message.answer("–ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π." if lang=="ru" else
                            "–ù–∞–¥—ñ—à–ª–∏ —Ç–µ–∫—Å—Ç —â–æ–¥–µ–Ω–Ω–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –æ–¥–Ω–∏–º —Ä—è–¥–∫–æ–º.")
    await cq.answer()

@router.callback_query(F.data.startswith("daily:done:"))
async def cb_daily_done(cq: types.CallbackQuery):
    task_id = int(cq.data.split(":")[2])
    daily_store.mark_done(task_id)
    await cq.message.edit_text("‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è")
    await cq.answer("–ì–æ—Ç–æ–≤–æ")

@router.callback_query(F.data.startswith("daily:del:"))
async def cb_daily_del(cq: types.CallbackQuery):
    task_id = int(cq.data.split(":")[2])
    daily_store.delete(task_id)
    await cq.message.edit_text("üóë –£–¥–∞–ª–µ–Ω–æ")
    await cq.answer("–£–¥–∞–ª–µ–Ω–æ")
